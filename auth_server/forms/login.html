<!-- GNU AGPL v3 License -->
<!DOCTYPE html>
<html>
    <head>
        <title>Login Form</title>
        <style type="text/css">
            .invisible {
                display: none;
            }
        </style>
        <script type="text/javascript">
            'use strict';

            var targetUrl = "%%base_url%%/internals/login";
            var serverUrl = "%%redirect_url%%";

            function queryParameter(name) {
                var rName = name.replace(/[\[\]]/g, '\\$&');
                var rgx = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
                var results = rgx.exec(window.location.href);

                if (!results) {
                    return undefined;
                }

                if (!results[2]) {
                    return "";
                }

                return decodeURIComponent(results[2].replace(/\+/g, " "));
            }

            function logIn() {
                // fetch username and password
                var usernameElem = document.getElementById("username");
                var passwordElem = document.getElementById("password");
                var username = usernameElem.value;
                var password = passwordElem.value;

                var loginUrl = targetUrl + "?state=";
                loginUrl += encodeURIComponent(queryParameter("state"));

                // set up XHR
                var request = new XMLHttpRequest();
                request.open(
                    "GET",
                    loginUrl,
                    true
                );
                request.setRequestHeader("Content-Type", "application/json");
                request.responseType = "json";
                request.onload = function() {
                    // request has finished, check result
                    var response = request.response;
                    if (response.hasOwnProperty("error")) {
                        // show error to user
                        var error = "Error: " + response.error;
                        var errorElem = document.getElementById("error");
                        errorElem.classList.remove("invisible");
                        errorElem.innerHTML = error;
                        return;
                    }

                    // redirect to the callback URL
                    var url = serverUrl + "?code=";
                    url += encodeURIComponent(response.code);
                    url += "&state=";
                    url += encodeURIComponent(response.state);

                    // go to that URL on the top level
                    var link = document.createElement("a");
                    link.href = url;
                    link.attributes["target"] = "_top";
                    link.click();
                };
                request.send(JSON.stringify({
                    username,
                    password
                }));
            }

            window.onload = function() {
                document.getElementById("login").onclick = logIn;
            };
        </script>
    </head>
    <body>
        <form>
            <p id="error" class="invisible"></p>
            <label for="username">Username:</label>
            <input id="username" type="text" />
            <label for="password">Password:</label>
            <input id="password" type="password" />
            <button id="login">Log In</button>
        </form>
    </body>
</html>